<!DOCTYPE html>
<html>
    <head>
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="manifest" href="manifest.json">
        <link rel="apple-touch-icon" href="icons/icon-192.png">
        <title>LOW-KEY</title>
        <style>
            :root {
                --bg-color: #fdf6e3;
                --accent: #ff4d4d;
                --text: #2c3e50;
            }

            body {
                background-color: var(--bg-color);
                font-family: 'Inter', sans-serif;
                overflow-x: hidden;
            }

            #thought-field {
                position: relative;
                height: 70vh;
                padding: 20px;
            }

            .thought-tile {
                background: white;
                padding: 15px 20px;
                border: 3px solid var(--text);
                border-radius: 15px; /* Change to 0 for a sharper TWEWY look */
                position: absolute;
                box-shadow: 8px 8px 0px var(--text);
                max-width: 250px;
                animation: drift 6s ease-in-out infinite alternate;
            }

            .author-tag {
                font-size: 0.7rem;
                font-weight: bold;
                text-transform: uppercase;
                color: var(--accent);
                margin-bottom: 5px;
            }

            @keyframes drift {
                from { transform: translateY(0px) rotate(-1deg); }
                to { transform: translateY(-15px) rotate(1deg); }
            }
        </style>
    </head>
<body>
  <h1>LOW-KEY: The Scan</h1>
  <input id="myThought" placeholder="Cast a thought..." />
  <button onclick="cast()">Cast</button>
  <div>Note: There is a rate-limit of 5 messages every 10 seconds. See the README at <a href="https://github.com/local-organic-worlds/key" target="_blank">https://github.com/local-organic-worlds/key</a> for more details on how this app works.</div>
  
  <div id="world">
    <div id="thought-field"></div>
    </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script type="module">
    import winkNaiveBayesTextClassifier from 'https://cdn.skypack.dev/wink-naive-bayes-text-classifier';
    const nbc = winkNaiveBayesTextClassifier();

    // Define simple text prep (no separate NLP library needed for basics)
    nbc.definePrepTasks([
        (text) => text.toLowerCase().split(/\W+/).filter(Boolean)
    ]);

    nbc.defineConfig({ smoothingFactor: 0.5 });

    // 1. Training - Feed it 5-10 examples per quadrant
    nbc.learn("How do I find the library basement?", "informative");
    nbc.learn("The exam is on Tuesday at 4pm", "informative");
    nbc.learn("Does anyone know where building 4 is?", "informative");

    nbc.learn("haha that is so funny lol", "playful");
    nbc.learn("anyone want to grab coffee? :P", "playful");
    nbc.learn("vibing in the lounge right now", "playful");

    nbc.learn("I am so overwhelmed with this project", "distressed");
    nbc.learn("I feel like I'm going to fail everything", "distressed");
    nbc.learn("everything is falling apart honestly", "distressed");

    nbc.learn("BUY CHEAP BITCOIN NOW !!!", "trash");
    nbc.learn("you are a total idiot and i hate you", "trash");
    nbc.learn("click this link for free prizes", "trash");

    // Consolidate the training
    nbc.consolidate();

    // 2. The Categorizer Function
    const categorizeThought = (text) => {
        const category = nbc.predict(text)
        console.log(`Categorised "${text}" as category: ${category}`)
        return category; // Returns the label: "informative", "playful", etc.
    };

    const socket = io('https://switchboard-production-04b2.up.railway.app');
    const world = document.getElementById('world');

    const adjectives = ["Crimson", "Vibrant", "Silent", "Hidden", "Neon", "Organic", "Solar", "Digital"];
    const nouns = ["Player", "Echo", "Seeker", "Ghost", "Loom", "World", "Signal", "Key"];

    const generateName = () => {
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        const num = Math.floor(100000 + Math.random() * 899999); // 6-digit suffix
        return `${adj} ${noun} ${num}`;
    };

    const myPersona = generateName();
    console.log(`Scanning as: ${myPersona}`);

    function cast() {

        const text = document.getElementById('myThought').value;
        
        const category = categorizeThought(text);

        if (category === "trash") {
            alert("⚠️ Thought dissolved: Content flagged as noise/toxic.");
            return; // Kill the message
        }

        // Apply specific CSS based on quadrant
        const colorMap = {
            "informative": "#3498db", // Blue
            "playful": "#f1c40f",    // Yellow
            "distressed": "#e67e22"  // Orange
        };

        socket.emit('broadcast-thought', { thought: text, key: myPersona, color: colorMap[category] });
    }

    window.cast = cast

    function displayNewThought(data) {
        
        const field = document.getElementById('thought-field');
        const tile = document.createElement('div');
        tile.className = 'thought-tile';
        
        // Randomize position so they float around the screen
        const x = Math.random() * (window.innerWidth - 200);
        const y = Math.random() * (window.innerHeight - 300);
        
        tile.style.left = `${x}px`;
        tile.style.top = `${y}px`;
        tile.style.color = data.color
        
        tile.innerHTML = `
            <div class="author-tag">${data.key}</div>
            <div class="thought-text">${data.thought}</div>
        `;
        
        field.appendChild(tile);

        // Guerilla Feature: Thoughts dissolve after 60 seconds
        setTimeout(() => {
            tile.style.opacity = '0';
            tile.style.transition = 'opacity 2s';
            setTimeout(() => tile.remove(), 2000);
        }, 60000);
    }

    displayNewThought({key: "Welcome Bot", thought: "Hello World! Welcome to the LOW-KEY World!", color: "black"})

    socket.on('new-thought', (data) => {
        displayNewThought(data)
    });

    socket.on('error-msg', (msg) => {
        alert(msg)
    });

    socket.on('user-left', (id) => {
      const tile = document.getElementById(id);
      if (tile) tile.remove(); // The "Dissolve" effect
    });
  </script>
</body>
</html>